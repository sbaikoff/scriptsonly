__author__ = 'SEBAIK'# This script is provided with no support or guarantees.# You may use it, modify and distribute with no restrictions# as long as original author is mentioned.## Script Auto-config a port when connecting an Cisco WIFI AP to a Comware7 5130 Switch## Usage:# script automatically when LLDP neighbor up/down is recognized by leveraging Comware EAA:## [Switch1]rtm cli-policy DOWN# [Switch1-rtm-DOWN]event syslog priority all msg LLDP_NEIGHBOR_AGE_OUT occurs 1 period 60# [Switch1-rtm-DOWN]action 0 cli python cisco_ap_config.py# [Switch1-rtm-DOWN]running-time 180# [Switch1-rtm-DOWN]user-role network-admin# [Switch1-rtm-DOWN]commit## [Switch1]rtm cli-policy UP# [Switch1-rtm-UP]event syslog priority all msg LLDP_CREATE_NEIGHBOR occurs 1 period 1# [Switch1-rtm-UP]action 0 cli python cisco_ap_config.py# [Switch1-rtm-UP]running-time 180# [Switch1-rtm-UP]user-role network-admin# [Switch1-rtm-UP]commit# Author: Serge BAIKOFF# Contact: serge.baikoff@hpe.comimport comwareimport sysimport reimport syslogap_config =     "undo packet-filter name AP-DENY inbound"default_ap_config =    "packet-filter name AP-DENY inbound"def get_config_port_ap_cisco():    tab = []    description = comware.CLI('display interface brief | include [Ww][Ii][Ff][Ii]|[Aa][Pp]', False).get_output()    for y in description:            if 'GE' in y:                start = y.rindex('GE') + 2                end = y.rindex('GE') + 8                port = 'GigabitEthernet' + y[start:end]                tab.append(port)    return tabdef check_if__ap_cisco(list):    tab = []    for i in list:        cdp = comware.CLI('display lldp neighbor-information interface %s verbose' %i, False).get_output()        for x in cdp:            if 'Platform version' in x:                ap_cisco = re.search(r'AIR-.*' , x)                if ap_cisco:                    tab.append(ap_cisco.group())                    break        else:            tab.append('No')    return tabdef main():    port = get_config_port_ap_cisco()    ap = check_if__ap_cisco(port)    for i,j in zip(port, ap):        if j == 'No':            comware.CLI('system-view ; interface ' + i + ' ; ' + default_ap_config +' ; return ; ', False)            syslog.openlog( 'WARNING', 0, syslog.LOG_LOCAL7 )            syslog.syslog(syslog.LOG_ALERT, 'Cisco AP MISSING ON PORT %s ' % i)        else:            comware.CLI('system-view ; interface ' + i + ' ; ' + ap_config + ' ; description ' "AP WIFI " + j + ' ; return ; ', False)if __name__ == "__main__":    main()
